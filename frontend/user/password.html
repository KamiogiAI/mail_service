<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パスワード変更</title>
    <link rel="stylesheet" href="../assets/common.css">
</head>
<body>
    <header class="header">
        <h1><a href="/form/index.html"><span class="site-name">Mail Service</span></a></h1>
        <nav id="header-nav">
            <a href="/form/user/mypage.html">マイページ</a>
            <a href="#" onclick="siteLogout();return false;">ログアウト</a>
        </nav>
    </header>

    <div class="container-narrow">
        <div class="page-card">
            <h2>パスワード変更</h2>
            <div class="form-group">
                <label>現在のパスワード</label>
                <input id="current-pw" type="password">
            </div>
            <div class="form-group">
                <label>新しいパスワード</label>
                <input id="new-pw" type="password" oninput="validatePassword()">
                <small>8文字以上、大文字・小文字・数字・記号のうち3種類以上</small>
                <div id="pw-hint" style="font-size:12px;margin-top:4px;"></div>
            </div>
            <button class="btn btn-block" onclick="changePw()">変更する</button>
            <div id="pw-msg" class="success-message"></div>
            <div id="pw-err" class="error-message"></div>
        </div>
    </div>

    <footer>
        <a href="/form/pages.html?type=terms">利用規約</a>
        <a href="/form/pages.html?type=company">運営会社</a>
        <a href="/form/pages.html?type=tokusho">特定商取引法</a>
    </footer>

    <script src="/assets/site.js"></script>
    <script src="js/api.js"></script>
    <script>
        function validatePassword() {
            const pw = document.getElementById('new-pw').value;
            const hintEl = document.getElementById('pw-hint');
            
            // アイコン生成
            const icon = (ok) => `<span style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:${ok ? '#28a745' : '#dc3545'};margin-right:6px;">
                <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                    ${ok 
                        ? '<path d="M2 5L4 7L8 3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'
                        : '<path d="M3 3L7 7M7 3L3 7" stroke="white" stroke-width="1.5" stroke-linecap="round"/>'}
                </svg>
            </span>`;
            
            const errors = [];
            
            // 8文字以上
            const lenOk = pw.length >= 8;
            errors.push(`<div style="display:flex;align-items:center;margin-bottom:4px;">${icon(lenOk)}<span style="color:${lenOk ? '#28a745' : '#666'}">8文字以上</span></div>`);
            
            // 種類チェック
            let categories = 0;
            const hasUpper = /[A-Z]/.test(pw);
            const hasLower = /[a-z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(pw);
            
            if (hasUpper) categories++;
            if (hasLower) categories++;
            if (hasNumber) categories++;
            if (hasSymbol) categories++;
            
            const typeOk = categories >= 3;
            const types = [
                hasUpper ? '大文字' : null,
                hasLower ? '小文字' : null,
                hasNumber ? '数字' : null,
                hasSymbol ? '記号' : null,
            ].filter(Boolean);
            
            errors.push(`<div style="display:flex;align-items:center;">${icon(typeOk)}<span style="color:${typeOk ? '#28a745' : '#666'}">3種類以上 (${types.length ? types.join('・') : '未入力'})</span></div>`);
            
            hintEl.innerHTML = errors.join('');
            
            return lenOk && typeOk;
        }
        
        async function changePw() {
            const msgEl = document.getElementById('pw-msg');
            const errEl = document.getElementById('pw-err');
            msgEl.textContent = '';
            errEl.textContent = '';
            
            const currentPw = document.getElementById('current-pw').value;
            const newPw = document.getElementById('new-pw').value;
            
            if (!currentPw) {
                errEl.textContent = '現在のパスワードを入力してください';
                return;
            }
            
            if (!validatePassword()) {
                errEl.textContent = '新しいパスワードが要件を満たしていません';
                return;
            }
            
            try {
                // 2段階認証: まずリクエスト送信
                const res = await API.post('/api/me/password-change/request', {
                    current_password: currentPw,
                });
                
                // 認証コード入力画面に遷移
                const token = res.token;
                document.querySelector('.page-card').innerHTML = `
                    <h2>認証コードを入力</h2>
                    <p style="color:#666;margin-bottom:15px;">メールに送信された6桁の認証コードを入力してください。</p>
                    <div class="form-group">
                        <label>認証コード</label>
                        <input id="verify-code" type="text" maxlength="6" placeholder="000000">
                    </div>
                    <button class="btn btn-block" onclick="confirmPwChange('${token}', '${newPw}')">パスワードを変更</button>
                    <div id="pw-msg" class="success-message"></div>
                    <div id="pw-err" class="error-message"></div>
                `;
            } catch (e) {
                errEl.textContent = e.message;
            }
        }
        
        async function confirmPwChange(token, newPw) {
            const msgEl = document.getElementById('pw-msg');
            const errEl = document.getElementById('pw-err');
            msgEl.textContent = '';
            errEl.textContent = '';
            
            const code = document.getElementById('verify-code').value;
            if (!code || code.length !== 6) {
                errEl.textContent = '6桁の認証コードを入力してください';
                return;
            }
            
            try {
                await API.post('/api/me/password-change/confirm', {
                    token: token,
                    code: code,
                    new_password: newPw,
                });
                msgEl.textContent = 'パスワードを変更しました';
                setTimeout(() => { location.href = 'mypage.html'; }, 2000);
            } catch (e) {
                errEl.textContent = e.message;
            }
        }
    </script>
</body>
</html>
